{"script":"-- key limit interval now [amount]\nlocal limit = tonumber(ARGV[1])\nlocal interval = tonumber(ARGV[2])\nlocal now = tonumber(ARGV[3])\nlocal amount = 1\n-- default the amount to 1 unless they specified one\nif ARGV[4] then\n    amount = math.max(tonumber(ARGV[4]), 0)\nend\nredis.call('ZREMRANGEBYSCORE', KEYS[1], '-inf', now - interval)\nlocal num = redis.call('ZCARD', KEYS[1])\n-- if we're already over the limit don't bother adding another timestamp\nif num + amount > limit then\n    return -1\nend\n-- convert to hex to save space\n-- append the num on the end so it doesn't clash with other values at same now\nlocal member = string.format(\"%x%x\", now, num)\nif amount > 0 then\n    -- if the amount is > 1 then we need to do a zadd with arguments for each\n    -- amount but if its just 1 then we can just do a regular zadd with 2 args\n    if amount > 1 then\n        local args = {'ZADD', KEYS[1]}\n        for i = 1, amount do\n            args[(i * 2) + 1] = now\n            args[(i * 2) + 2] = member .. tostring(i)\n        end\n        num = num + redis.call(unpack(args))\n    else\n        num = num + redis.call('ZADD', KEYS[1], now, member)\n    end\n    -- only actually update expire if they added a new token\n    redis.call('PEXPIRE', KEYS[1], interval)\nend\nreturn limit - num\n","sha1":"9bc1e45d265b008f3d00b5ed2380115ee7a62bcf"}