{"script":"-- key limit intervalMS nowMS [amount]\nlocal key = KEYS[1]\nlocal limit = tonumber(ARGV[1])\nlocal intervalMS = tonumber(ARGV[2])\nlocal nowMS = tonumber(ARGV[3])\n-- default the amount to 1 unless they specified one\nlocal amount = 1\nif ARGV[4] then\n    amount = math.max(tonumber(ARGV[4]), 0)\nend\n\nredis.call('ZREMRANGEBYSCORE', key, '-inf', nowMS - intervalMS)\nlocal num = redis.call('ZCARD', key)\n\nlocal left = limit - num - amount\n-- if we're already over the limit don't bother adding another timestamp\nif left < 0 then\n    return -1\nend\n\n-- convert to hex to save space\n-- append the num on the end so it doesn't clash with other values at same nowMS\nif amount > 0 then\n    local args = {'ZADD', key}\n    for i = 1, amount do\n        args[(i * 2) + 1] = nowMS\n        args[(i * 2) + 2] = string.format(\"%x%x%s\", nowMS, num, i)\n    end\n    redis.call(unpack(args))\n    -- only actually update expire if they added a new token\n    redis.call('PEXPIRE', key, intervalMS)\nend\nreturn left\n","sha1":"4539493323bc51cde4ff8a3ce6557be3d1e7864b"}