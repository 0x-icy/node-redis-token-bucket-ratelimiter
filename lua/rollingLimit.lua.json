{"script":"-- key limit interval now [amount]\nlocal limit = tonumber(ARGV[1])\nlocal interval = tonumber(ARGV[2])\nlocal now = tonumber(ARGV[3])\nlocal amount = 1\nif ARGV[4] then\n    amount = math.max(tonumber(ARGV[4]), 0)\nend\nredis.call('ZREMRANGEBYSCORE', KEYS[1], '-inf', now - interval)\nlocal num = redis.call('ZCARD', KEYS[1])\nif num + amount > limit then\n    return -1\nend\n-- only take the first 30 bits then convert to hex to save space\nlocal member = string.format(\"%x%x\", bit.band(now, 1073741823), num)\nif amount > 0 then\n    if amount > 1 then\n        local args = {'ZADD', KEYS[1]}\n        for i = 1, amount do\n            args[(i * 2) + 1] = now\n            args[(i * 2) + 2] = member .. tostring(i)\n        end\n        num = num + redis.call(unpack(args))\n    else\n        num = num + redis.call('ZADD', KEYS[1], now, member)\n    end\n    -- only actually update expire if they added a new token\n    redis.call('PEXPIRE', KEYS[1], interval)\nend\nreturn limit - num\n","sha1":"85bbbfaa98e88350f497e45a77ad83582c5ade0f"}